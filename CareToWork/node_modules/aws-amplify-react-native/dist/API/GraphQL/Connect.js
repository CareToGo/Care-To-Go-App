var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));require("regenerator-runtime/runtime");var _react=require("react");var _parser=require("graphql/language/parser");var _awsAmplify=require("aws-amplify");function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var getOperationType=function getOperationType(operation){var doc=(0,_parser.parse)(operation);var _doc$definitions=(0,_slicedToArray2.default)(doc.definitions,1),operationType=_doc$definitions[0].operation;return operationType;};var Connect=function(_Component){(0,_inherits2.default)(Connect,_Component);var _super=_createSuper(Connect);function Connect(props){var _this;(0,_classCallCheck2.default)(this,Connect);_this=_super.call(this,props);_this.state=_this.getInitialState();_this.subSubscription=null;return _this;}(0,_createClass2.default)(Connect,[{key:"getInitialState",value:function getInitialState(){var query=this.props.query;return{loading:query&&!!query.query,data:{},errors:[],mutation:function mutation(){return console.warn('Not implemented');}};}},{key:"getDefaultState",value:function getDefaultState(){return{loading:false,data:{},errors:[],mutation:function mutation(){return console.warn('Not implemented');}};}},{key:"_fetchData",value:function _fetchData(){var _this2=this;var _this$props,_this$props$query,query,_this$props$query$var,variables,_this$props$mutation,mutation,_this$props$mutation$,mutationVariables,subscription,_this$props$onSubscri,onSubscriptionMsg,_this$getDefaultState,data,mutationProp,errors,hasValidQuery,hasValidMutation,hasValidSubscription,response,subsQuery,subsVars,observable;return _regenerator.default.async(function _fetchData$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this._unsubscribe();this.setState({loading:true});_this$props=this.props,_this$props$query=_this$props.query;_this$props$query=_this$props$query===void 0?{}:_this$props$query;query=_this$props$query.query,_this$props$query$var=_this$props$query.variables,variables=_this$props$query$var===void 0?{}:_this$props$query$var,_this$props$mutation=_this$props.mutation;_this$props$mutation=_this$props$mutation===void 0?{}:_this$props$mutation;mutation=_this$props$mutation.query,_this$props$mutation$=_this$props$mutation.mutationVariables,mutationVariables=_this$props$mutation$===void 0?{}:_this$props$mutation$,subscription=_this$props.subscription,_this$props$onSubscri=_this$props.onSubscriptionMsg,onSubscriptionMsg=_this$props$onSubscri===void 0?function(prevData){return prevData;}:_this$props$onSubscri;_this$getDefaultState=this.getDefaultState(),data=_this$getDefaultState.data,mutationProp=_this$getDefaultState.mutation,errors=_this$getDefaultState.errors;hasValidQuery=query&&getOperationType(query)==='query';hasValidMutation=mutation&&getOperationType(mutation)==='mutation';hasValidSubscription=subscription&&getOperationType(subscription.query)==='subscription';if(!hasValidQuery&&!hasValidMutation&&!hasValidSubscription){console.warn('No query, mutation or subscription was specified');}if(!hasValidQuery){_context2.next=25;break;}_context2.prev=13;data=null;_context2.next=17;return _regenerator.default.awrap(_awsAmplify.API.graphql({query:query,variables:variables}));case 17:response=_context2.sent;data=response.data;_context2.next=25;break;case 21:_context2.prev=21;_context2.t0=_context2["catch"](13);data=_context2.t0.data;errors=_context2.t0.errors;case 25:if(hasValidMutation){mutationProp=function _callee(variables){var result;return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(_awsAmplify.API.graphql({query:mutation,variables:variables}));case 2:result=_context.sent;_this2.forceUpdate();return _context.abrupt("return",result);case 5:case"end":return _context.stop();}}},null,null,null,Promise);};}if(hasValidSubscription){subsQuery=subscription.query,subsVars=subscription.variables;try{observable=_awsAmplify.API.graphql({query:subsQuery,variables:subsVars});this.subSubscription=observable.subscribe({next:function next(_ref){var data=_ref.value.data;var prevData=_this2.state.data;var newData=onSubscriptionMsg(prevData,data);_this2.setState({data:newData});},error:function error(err){return console.error(err);}});}catch(err){errors=err.errors;}}this.setState({data:data,errors:errors,mutation:mutationProp,loading:false});case 28:case"end":return _context2.stop();}}},null,this,[[13,21]],Promise);}},{key:"_unsubscribe",value:function _unsubscribe(){if(this.subSubscription){this.subSubscription.unsubscribe();}}},{key:"componentDidMount",value:function componentDidMount(){return _regenerator.default.async(function componentDidMount$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:this._fetchData();case 1:case"end":return _context3.stop();}}},null,this,null,Promise);}},{key:"componentWillUnmount",value:function componentWillUnmount(){this._unsubscribe();}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){var loading=this.state.loading;var _this$props2=this.props,newQueryObj=_this$props2.query,newMutationObj=_this$props2.mutation;var prevQueryObj=prevProps.query,prevMutationObj=prevProps.mutation;var _ref2=newQueryObj||{},newQuery=_ref2.query,newQueryVariables=_ref2.variables;var _ref3=prevQueryObj||{},prevQuery=_ref3.query,prevQueryVariables=_ref3.variables;var queryChanged=prevQuery!==newQuery||JSON.stringify(prevQueryVariables)!==JSON.stringify(newQueryVariables);var _ref4=newMutationObj||{},newMutation=_ref4.query,newMutationVariables=_ref4.variables;var _ref5=prevMutationObj||{},prevMutation=_ref5.query,prevMutationVariables=_ref5.variables;var mutationChanged=prevMutation!==newMutation||JSON.stringify(prevMutationVariables)!==JSON.stringify(newMutationVariables);if(!loading&&(queryChanged||mutationChanged)){this._fetchData();}}},{key:"render",value:function render(){var _this$state=this.state,data=_this$state.data,loading=_this$state.loading,mutation=_this$state.mutation,errors=_this$state.errors;return this.props.children({data:data,errors:errors,loading:loading,mutation:mutation})||null;}}]);return Connect;}(_react.Component);exports.default=Connect;